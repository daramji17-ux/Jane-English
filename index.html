<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kids English Stories</title>

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    header { padding: 16px; background: #ffffff; border-bottom: 1px solid #e6e8ee; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: 1px solid #e6e8ee; border-radius: 12px; padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    label { font-size: 12px; color: #444; }
    select, input[type="number"] {
      padding: 8px 10px; border: 1px solid #d7dbe6; border-radius: 10px; background: #fff; font-size: 14px;
    }
    button {
      padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dbe6; background: #fff; cursor: pointer;
      font-size: 14px;
    }
    button.primary { background: #0b5fff; color: #fff; border-color: #0b5fff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .muted { color: #666; font-size: 12px; }
    .status { margin-top: 8px; font-size: 12px; }
    .status .ok { color: #146c2e; }
    .status .warn { color: #8a6d00; }
    .status .err { color: #b00020; }
    .sentences { margin-top: 14px; display: flex; flex-direction: column; gap: 8px; }
    .sentence {
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      border: 1px solid #e6e8ee; border-radius: 12px; padding: 12px;
      background: #fff;
    }
    .sentence.active { outline: 2px solid rgba(11,95,255,0.25); border-color: rgba(11,95,255,0.35); }
    .text { line-height: 1.35; }
    .en { font-size: 16px; }
    .ko { font-size: 13px; color: #444; margin-top: 6px; }
    .btns { display: flex; gap: 8px; align-items: center; }
    .tiny { font-size: 12px; padding: 8px 10px; }
    footer { padding: 18px; text-align: center; font-size: 12px; color: #666; }
    .controls { display: grid; gap: 10px; }
    .controls .line { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .controls .btn { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border: 1px solid #e6e8ee; border-radius: 999px;
      font-size: 12px; color: #444; background: #fff;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Kids English Stories</h1>
    <div class="muted">Sentence-by-sentence listening & repeating (with optional Korean).</div>
  </div>
</header>

<main class="wrap">
  <div class="card controls">
    <div class="line">
      <div>
        <label for="storySelect">Story</label><br/>
        <select id="storySelect"></select>
      </div>

      <div>
        <label for="voiceSelect">Voice (TTS)</label><br/>
        <select id="voiceSelect"></select>
      </div>

      <div>
        <label>&nbsp;</label><br/>
        <button id="refreshVoices" class="tiny">Refresh voices</button>
      </div>

      <span class="pill" id="modePill" title="Display mode">Mode: All</span>
    </div>

    <div class="line">
      <div>
        <label for="rate">Speed</label><br/>
        <input id="rate" type="number" value="0.95" min="0.6" max="1.3" step="0.05" />
      </div>

      <div>
        <label for="repeat">Repeat</label><br/>
        <input id="repeat" type="number" value="1" min="1" max="10" step="1" />
      </div>

      <div>
        <label for="interval">Interval (sec)</label><br/>
        <input id="interval" type="number" value="0.6" min="0" max="6" step="0.1" />
      </div>

      <div class="btn">
        <button class="primary" id="playAll">Play All</button>
        <button id="stop">Stop</button>

        <!-- Test / Level UI -->
        <button id="testBtn" type="button">테스트</button>
        <button id="resetBtn" type="button">전체 보기</button>

        <span id="levelBox" style="display:none; margin-left:8px;">
          <label for="levelSelect">레벨:</label>
          <select id="levelSelect">
            <option value="beginner">초급</option>
            <option value="intermediate">중급</option>
            <option value="advanced">고급</option>
          </select>
        </span>
      </div>
    </div>

    <div class="status" id="statusLine"></div>
  </div>

  <div class="sentences" id="sentences"></div>
</main>

<footer>Made for kids learning English</footer>

<script>
/* ================== ELEMENTS ================== */
const storySelect = document.getElementById("storySelect");
const voiceSelect = document.getElementById("voiceSelect");
const sentencesEl = document.getElementById("sentences");

const playAllBtn = document.getElementById("playAll");
const stopBtn = document.getElementById("stop");
const testBtn = document.getElementById("testBtn");
const resetBtn = document.getElementById("resetBtn");
const levelBox = document.getElementById("levelBox");
const levelSelect = document.getElementById("levelSelect");
const refreshVoicesBtn = document.getElementById("refreshVoices");

const rateInput = document.getElementById("rate");
const repeatInput = document.getElementById("repeat");
const intervalInput = document.getElementById("interval");

const statusLine = document.getElementById("statusLine");
const modePill = document.getElementById("modePill");

/* ================== STATE ================== */
let voices = [];
let manifest = [];         // list of stories from manifest.json
let currentStory = null;   // { title, sentences: [{idx,text,ko}] }
let playingAll = false;

// Display mode:
// - "all": show full EN + full KO (default on every new visit)
// - "beginner": show EN hint + KO
// - "intermediate": show KO only
// - "advanced": show nothing
let displayMode = "all";

// keep active row across re-render
let lastHighlightedIdx = -1;

/* ================== HELPERS ================== */
function setStatusLine(items){
  statusLine.innerHTML = "";
  for (const it of (items || [])){
    const span = document.createElement("span");
    span.textContent = it.text;
    span.className = it.cls || "";
    span.style.marginRight = "10px";
    statusLine.appendChild(span);
  }
}

function setModePill(){
  const label =
    displayMode === "all" ? "All" :
    displayMode === "beginner" ? "Beginner" :
    displayMode === "intermediate" ? "Intermediate" :
    "Advanced";
  modePill.textContent = `Mode: ${label}`;
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function stopAll(){
  playingAll = false;
  window.speechSynthesis.cancel();
  setStatusLine([{ text: "Stopped.", cls: "warn" }]);
}

function highlight(idx){
  document.querySelectorAll(".sentence").forEach(el => el.classList.remove("active"));
  const row = document.querySelector(`.sentence[data-idx="${idx}"]`);
  if (row) row.classList.add("active");
  lastHighlightedIdx = idx;
}

function getSelectedVoice(){
  const name = voiceSelect.value;
  return voices.find(v => v.name === name) || voices[0] || null;
}

function normalizeStory(storyJson){
  // Accept either:
  // { title, sentences: [{en, ko} ...] }
  // or { title, lines: [{text, ko} ...] }
  const title = storyJson.title || storyJson.name || "Untitled";
  const arr = storyJson.sentences || storyJson.lines || storyJson.data || [];
  const sentences = arr.map((x, i) => ({
    idx: i,
    text: x.text ?? x.en ?? x.english ?? "",
    ko: x.ko ?? x.korean ?? x.kr ?? ""
  }));
  return { title, sentences };
}

/* ================== VOICES ================== */
function loadVoices(){
  voices = window.speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = "";

  if (!voices.length){
    setStatusLine([{ text: "No voices yet. Try Refresh voices or wait a moment.", cls: "warn" }]);
    return;
  }

  // Prefer English voices first
  const sorted = [...voices].sort((a,b) => {
    const aEn = (a.lang || "").toLowerCase().startsWith("en");
    const bEn = (b.lang || "").toLowerCase().startsWith("en");
    if (aEn !== bEn) return aEn ? -1 : 1;
    return (a.name || "").localeCompare(b.name || "");
  });

  for (const v of sorted){
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  }

  const firstEn = sorted.find(v => (v.lang || "").toLowerCase().startsWith("en"));
  if (firstEn) voiceSelect.value = firstEn.name;

  setStatusLine([{ text: `Voices loaded: ${voices.length}`, cls: "ok" }]);
}

window.speechSynthesis.onvoiceschanged = () => loadVoices();

/* ================== DATA LOAD ================== */
async function loadManifest(){
  const res = await fetch("./stories/manifest.json", { cache: "no-store" });
  if (!res.ok) throw new Error(`manifest.json load failed: ${res.status}`);
  const json = await res.json();
  manifest = Array.isArray(json) ? json : (json.stories || []);
  return manifest;
}

function renderManifestOptions(){
  storySelect.innerHTML = "";
  for (const st of manifest){
    const opt = document.createElement("option");
    opt.value = st.id || st.file || st.slug || st.title;
    opt.textContent = st.title || st.name || st.id || st.file;
    opt.dataset.file = st.file || st.path || st.id;
    storySelect.appendChild(opt);
  }
}

function resolveStoryFileById(id){
  const st = manifest.find(x => (x.id || x.file || x.slug || x.title) === id) || manifest[0];
  if (!st) return null;
  return st.file || st.path || (st.id ? `${st.id}.json` : null);
}

async function loadStoryById(id){
  const file = resolveStoryFileById(id);
  if (!file) throw new Error("No story file found.");
  const res = await fetch(`./stories/${file}`, { cache: "no-store" });
  if (!res.ok) throw new Error(`${file} load failed: ${res.status}`);
  const json = await res.json();
  currentStory = normalizeStory(json);
  renderSentences();
  setStatusLine([{ text: `Loaded story: ${currentStory.title}`, cls: "ok" }]);
}

/* ================== SPEAK ================== */
async function speak(text){
  return new Promise((resolve, reject) => {
    if (!text || !text.trim()){
      resolve();
      return;
    }

    const u = new SpeechSynthesisUtterance(text);
    const v = getSelectedVoice();
    if (v) u.voice = v;

    const rate = parseFloat(rateInput.value || "1");
    u.rate = isFinite(rate) ? rate : 1;

    u.onend = () => resolve();
    u.onerror = (e) => reject(e.error || e);

    window.speechSynthesis.speak(u);
  });
}

async function playSentence(idx, repeatOverride){
  const s = currentStory?.sentences?.[idx];
  if (!s) return;

  highlight(idx);

  const repeatCount = repeatOverride ?? parseInt(repeatInput.value || "1", 10);
  for (let r=0; r<repeatCount; r++){
    await speak(s.text);
    const intervalMs = Math.max(0, parseFloat(intervalInput.value || "0")) * 1000;
    if (intervalMs) await sleep(intervalMs);
  }
}

async function playAll(){
  if (!currentStory) return;
  playingAll = true;
  setStatusLine([{ text: "Playing all…", cls: "ok" }]);

  try{
    for (const s of currentStory.sentences){
      if (!playingAll) break;
      await playSentence(s.idx);
    }
  }catch(err){
    setStatusLine([{ text: `TTS error: ${String(err)}`, cls: "err" }]);
  }finally{
    playingAll = false;
  }
}

/* ================== RENDER HELPERS (MODE) ================== */
function englishHint(text, wordsToShow = 2) {
  const words = (text || "").trim().split(/\s+/);
  if (words.length <= wordsToShow) return text || "";
  return words.slice(0, wordsToShow).join(" ") + " …";
}

function applyModeToSentenceElements(enEl, koEl, s){
  if (displayMode === "all") {
    enEl.style.display = "";
    koEl.style.display = "";
    enEl.textContent = s.text || "";
    koEl.textContent = s.ko || "";
    return;
  }

  if (displayMode === "beginner") {
    enEl.style.display = "";
    koEl.style.display = "";
    enEl.textContent = englishHint(s.text || "", 2); // 일부 영어 + 한글
    koEl.textContent = s.ko || "";
  } else if (displayMode === "intermediate") {
    enEl.style.display = "none";
    koEl.style.display = "";
    enEl.textContent = "";
    koEl.textContent = s.ko || "";
  } else {
    enEl.style.display = "none";
    koEl.style.display = "none";
    enEl.textContent = "";
    koEl.textContent = "";
  }
}

/* ================== RENDER ================== */
function renderSentences(){
  sentencesEl.innerHTML = "";
  if (!currentStory) return;

  for (const s of currentStory.sentences){
    const row = document.createElement("div");
    row.className = "sentence";
    row.dataset.idx = String(s.idx);

    const textWrap = document.createElement("div");

    const en = document.createElement("div");
    en.className = "text en";

    const ko = document.createElement("div");
    ko.className = "text ko";

    applyModeToSentenceElements(en, ko, s);

    textWrap.appendChild(en);
    textWrap.appendChild(ko);

    const btns = document.createElement("div");
    btns.className = "btns";

    const playBtn = document.createElement("button");
    playBtn.className = "tiny";
    playBtn.textContent = "Play";
    playBtn.addEventListener("click", () => playSentence(s.idx, 1));

    const repBtn = document.createElement("button");
    repBtn.className = "tiny";
    repBtn.textContent = "Repeat x2";
    repBtn.addEventListener("click", () => playSentence(s.idx, 2));

    row.addEventListener("click", (e) => {
      if (e.target && e.target.tagName === "BUTTON") return;
      playSentence(s.idx, 1);
    });

    btns.appendChild(playBtn);
    btns.appendChild(repBtn);

    row.appendChild(textWrap);
    row.appendChild(btns);
    sentencesEl.appendChild(row);
  }

  if (lastHighlightedIdx >= 0) highlight(lastHighlightedIdx);
}

/* ================== EVENTS ================== */
storySelect.addEventListener("change", async (e) => {
  stopAll();
  try{
    await loadStoryById(e.target.value);
  }catch(err){
    setStatusLine([{ text: String(err.message || err), cls: "err" }]);
  }
});

refreshVoicesBtn.addEventListener("click", () => loadVoices());
playAllBtn.addEventListener("click", () => playAll());
stopBtn.addEventListener("click", () => stopAll());

// Test: toggle level selector
testBtn.addEventListener("click", () => {
  levelBox.style.display = (levelBox.style.display === "none") ? "inline-block" : "none";
});

// Level selection changes displayMode (does NOT persist across visits)
levelSelect.addEventListener("change", () => {
  const v = levelSelect.value;
  displayMode = v;               // beginner/intermediate/advanced
  setModePill();
  renderSentences();
});

// Reset: show everything again (EN full + KO full)
resetBtn.addEventListener("click", () => {
  displayMode = "all";
  setModePill();
  // keep the selector value as-is (optional), but most users expect it to reset visually too:
  levelSelect.value = "beginner";
  renderSentences();
});

/* ================== INIT ================== */
(async function init(){
  setModePill();

  loadVoices();
  // voices can appear late; retry a couple of times
  setTimeout(loadVoices, 300);
  setTimeout(loadVoices, 900);

  try{
    await loadManifest();
    renderManifestOptions();

    if (storySelect.options.length){
      await loadStoryById(storySelect.value);
    }else{
      setStatusLine([{ text: "No stories in manifest.json", cls: "warn" }]);
    }
  }catch(err){
    setStatusLine([
      { text: "Failed to initialize.", cls: "err" },
      { text: String(err.message || err), cls: "err" }
    ]);
  }
})();
</script>
</body>
</html>
