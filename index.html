<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kids English Stories</title>

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    body { margin: 0; background: #f6f7f9; color: #111; }
    header { padding: 16px; background: #ffffff; border-bottom: 1px solid #e6e8ee; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    .sub { margin-top: 6px; font-size: 13px; color: #555; }

    main { padding: 16px; max-width: 920px; margin: 0 auto; }
    .card { background: #ffffff; border: 1px solid #e6e8ee; border-radius: 16px; padding: 16px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .label { font-size: 13px; color: #555; margin-bottom: 6px; }

    select, button, input {
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d4d8e2;
      background: #fff;
    }
    button { cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }

    .hint { margin-top: 10px; font-size: 12px; color: #666; }

    /* 3 inputs + 2 buttons layout */
    .controls {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(3, minmax(140px, 1fr));
      gap: 10px;
      align-items: end;
    }
    .controls .btn { grid-column: span 3; display: flex; gap: 10px; flex-wrap: wrap; }
    .controls .btn button { flex: 1; min-width: 140px; }

    .badges { display:flex; justify-content: space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom: 10px; }
    .pill {
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid #e6e8ee; background:#f0f2f8;
      font-size:12px; color:#333;
    }
    .warn { background:#fff6e5; border-color:#ffe2b3; color:#7a3b00; }

    .sentences { margin-top: 18px; display: grid; gap: 12px; }

    .sentence {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #eef0f6;
      background: #fafbff;
    }

    /* Highlight: soft yellow */
    .sentence.active { background: #fff4cc; border-color: #f4b400; }
    .text.en { font-size: 18px; line-height: 1.35; font-weight: 500; }
    .sentence.active .text.en { font-weight: 700; }
    .text.ko { margin-top: 4px; font-size: 14px; color: #666; }
    .sentence.active .text.ko { color: #5c4a00; }

    .btns { display: flex; gap: 8px; align-items: center; }

    footer { text-align: center; font-size: 12px; color: #666; padding: 20px 0; }

    @media (prefers-color-scheme: dark) {
      body { background:#0b0c10; color:#f1f1f1; }
      header, .card { background:#12131a; border-color:#26283a; }
      select, button, input { background:#12131a; color:#f1f1f1; border-color:#26283a; }
      .sub, .label, .hint, footer { color:#b8b8c7; }
      .sentence { background:#151826; border-color:#20233a; }
      .sentence.active { background:#3b3200; border-color:#f4b400; }
      .text.ko { color:#b8b8c7; }
      .sentence.active .text.ko { color:#ffe08a; }
      .pill { background:#151826; border-color:#26283a; color:#d8d8e6; }
      .warn { background:#2a1d00; border-color:#5b3a00; color:#ffd9a3; }
    }
  </style>
</head>

<body>
<header>
  <h1> Ïû¨Ïù∏Ïù¥Ïùò ÏòÅÏñ¥ Í≥µÎ∂Ä ÏÑ∏ÏÉÅ</h1>
  <div class="sub">Sentence by sentence English listening</div>
</header>

<main>
  <div class="card">

    <div class="badges">
      <div class="row">
        <div class="pill">English + Korean</div>
        <div class="pill warn" id="voiceStatus">Voice: loading...</div>
      </div>
      <div class="row">
        <button id="refreshVoices">Refresh voices</button>
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width: 280px;">
        <div class="label">Story</div>
        <select id="storySelect" style="width:100%;"></select>
      </div>
      <div style="flex:1; min-width: 280px;">
        <div class="label">Voice</div>
        <select id="voiceSelect" style="width:100%;"></select>
      </div>
    </div>

    <div class="controls">
      <div>
        <div class="label">Speed</div>
        <input id="rate" type="number" step="0.05" min="0.6" max="1.1" value="0.85">
      </div>
      <div>
        <div class="label">Repeat</div>
        <input id="repeat" type="number" min="1" max="3" value="1">
      </div>
      <div>
        <div class="label">Interval (sec)</div>
        <input id="interval" type="number" min="0" max="5" step="0.5" value="1.5">
      </div>

      <div class="btn">
        <button class="primary" id="playAll">Play All</button>
        <button id="stop">Stop</button>
      </div>
    </div>

    <div class="hint">
      If Voice is empty: tap any ‚ñ∂ once, then press ‚ÄúRefresh voices‚Äù. For best stability, open via your GitHub Pages URL in Safari.
    </div>

    <div class="sentences" id="sentences"></div>
  </div>
</main>

<footer>Made for kids learning English</footer>

<script>
/* ============ DATA (Aesop-based, edited) ============ */
const stories = [
  {
    id: "aesop_02",
    title: "The Tortoise and the Hare",
    level: 1,
    sentences: [
      { idx: 1, text: "A hare was very fast.", ko: "ÌÜ†ÎÅºÎäî ÏïÑÏ£º Îπ®ÎûêÏñ¥Ïöî." },
      { idx: 2, text: "A tortoise was very slow.", ko: "Í±∞Î∂ÅÏù¥Îäî ÏïÑÏ£º ÎäêÎ†∏Ïñ¥Ïöî." },
      { idx: 3, text: "The hare laughed at the tortoise.", ko: "ÌÜ†ÎÅºÎäî Í±∞Î∂ÅÏù¥Î•º ÎπÑÏõÉÏóàÏñ¥Ïöî." },
      { idx: 4, text: "The tortoise felt calm.", ko: "Í±∞Î∂ÅÏù¥Îäî Ï∞®Î∂ÑÌñàÏñ¥Ïöî." },
      { idx: 5, text: "The hare said, \"Let us race.\"", ko: "ÌÜ†ÎÅºÍ∞Ä ÎßêÌñàÏñ¥Ïöî. \"Í≤ΩÏ£ºÌïòÏûê.\"" },
      { idx: 6, text: "The race started in the morning.", ko: "Í≤ΩÏ£ºÎäî ÏïÑÏπ®Ïóê ÏãúÏûëÌñàÏñ¥Ïöî." },
      { idx: 7, text: "The hare ran very fast.", ko: "ÌÜ†ÎÅºÎäî ÏïÑÏ£º Îπ†Î•¥Í≤å Îã¨Î†∏Ïñ¥Ïöî." },
      { idx: 8, text: "Soon, he was far ahead.", ko: "Í≥ß Í∑∏Îäî Î©ÄÎ¶¨ ÏïûÏÑú ÏûàÏóàÏñ¥Ïöî." },
      { idx: 9, text: "The hare felt sleepy.", ko: "ÌÜ†ÎÅºÎäî Ï°∏Î¶¨Í∏∞ ÏãúÏûëÌñàÏñ¥Ïöî." },
      { idx: 10, text: "He stopped and fell asleep.", ko: "Í∑∏Îäî Î©àÏ∂∞ÏÑú Ïû†Ïù¥ Îì§ÏóàÏñ¥Ïöî." },
      { idx: 11, text: "The tortoise walked slowly.", ko: "Í±∞Î∂ÅÏù¥Îäî Ï≤úÏ≤úÌûà Í±∏ÏóàÏñ¥Ïöî." },
      { idx: 12, text: "He did not stop.", ko: "Í∑∏Îäî Î©àÏ∂îÏßÄ ÏïäÏïòÏñ¥Ïöî." },
      { idx: 13, text: "The tortoise reached the goal.", ko: "Í±∞Î∂ÅÏù¥Îäî Í≤∞ÏäπÏ†êÏóê ÎèÑÏ∞©ÌñàÏñ¥Ïöî." },
      { idx: 14, text: "Slow and steady wins the race.", ko: "Ï≤úÏ≤úÌûà Íæ∏Ï§ÄÌïòÎ©¥ Í≤∞Íµ≠ Ïù¥Í≤®Ïöî." }
    ]
  },
  {
    id: "aesop_03",
    title: "The Lion and the Mouse",
    level: 1,
    sentences: [
      { idx: 1, text: "A lion was sleeping.", ko: "ÏÇ¨ÏûêÎäî ÏûêÍ≥† ÏûàÏóàÏñ¥Ïöî." },
      { idx: 2, text: "A small mouse ran over him.", ko: "ÏûëÏùÄ Ï•êÍ∞Ä ÏÇ¨Ïûê ÏúÑÎ•º Îã¨Î†∏Ïñ¥Ïöî." },
      { idx: 3, text: "The lion woke up.", ko: "ÏÇ¨ÏûêÎäî Íπ®Ïñ¥ÎÇ¨Ïñ¥Ïöî." },
      { idx: 4, text: "He caught the mouse.", ko: "ÏÇ¨ÏûêÎäî Ï•êÎ•º Î∂ôÏû°ÏïòÏñ¥Ïöî." },
      { idx: 5, text: "The mouse said, \"Please let me go.\"", ko: "Ï•êÍ∞Ä ÎßêÌñàÏñ¥Ïöî. \"Ï†úÎ∞ú ÏÇ¥Î†§Ï£ºÏÑ∏Ïöî.\"" },
      { idx: 6, text: "The lion laughed.", ko: "ÏÇ¨ÏûêÎäî ÏõÉÏóàÏñ¥Ïöî." },
      { idx: 7, text: "He let the mouse go.", ko: "Í∑∏Îäî Ï•êÎ•º ÎÜìÏïÑÏ£ºÏóàÏñ¥Ïöî." },
      { idx: 8, text: "Later, the lion was trapped.", ko: "ÎÇòÏ§ëÏóê ÏÇ¨ÏûêÎäî Îç´Ïóê Í±∏Î†∏Ïñ¥Ïöî." },
      { idx: 9, text: "The mouse came back.", ko: "Ï•êÍ∞Ä Îã§Ïãú ÏôîÏñ¥Ïöî." },
      { idx: 10, text: "The mouse bit the rope.", ko: "Ï•êÎäî Î∞ßÏ§ÑÏùÑ Í∞âÏïòÏñ¥Ïöî." },
      { idx: 11, text: "The lion was free.", ko: "ÏÇ¨ÏûêÎäî ÏûêÏú†Î°úÏõåÏ°åÏñ¥Ïöî." },
      { idx: 12, text: "Kindness is never wasted.", ko: "ÏπúÏ†àÏùÄ Ï†àÎåÄ ÌóõÎêòÏßÄ ÏïäÏïÑÏöî." }
    ]
  }
];

/* ============ ELEMENTS ============ */
const storySelect = document.getElementById("storySelect");
const voiceSelect = document.getElementById("voiceSelect");
const sentencesEl = document.getElementById("sentences");

const playAllBtn = document.getElementById("playAll");
const stopBtn = document.getElementById("stop");
const refreshVoicesBtn = document.getElementById("refreshVoices");

const rateInput = document.getElementById("rate");
const repeatInput = document.getElementById("repeat");
const intervalInput = document.getElementById("interval");

const voiceStatus = document.getElementById("voiceStatus");

let voices = [];
let currentStory = stories[0];
let playingAll = false;

/* ============ HELPERS ============ */
function setStatus(text, warn=false){
  voiceStatus.textContent = text;
  voiceStatus.classList.toggle("warn", warn);
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function populateStories(){
  storySelect.innerHTML = "";
  for (const s of stories){
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.title} (Level ${s.level})`;
    storySelect.appendChild(opt);
  }
  storySelect.value = currentStory.id;
}

function renderSentences(){
  sentencesEl.innerHTML = "";
  for (const s of currentStory.sentences){
    const row = document.createElement("div");
    row.className = "sentence";
    row.dataset.idx = String(s.idx);

    const textWrap = document.createElement("div");

    const en = document.createElement("div");
    en.className = "text en";
    en.textContent = s.text;

    const ko = document.createElement("div");
    ko.className = "text ko";
    ko.textContent = s.ko || "";

    textWrap.appendChild(en);
    textWrap.appendChild(ko);

    const btns = document.createElement("div");
    btns.className = "btns";

    const playBtn = document.createElement("button");
    playBtn.textContent = "‚ñ∂";
    playBtn.addEventListener("click", () => playSentence(s.idx, 1));

    const repBtn = document.createElement("button");
    repBtn.textContent = "üîÅ";
    repBtn.addEventListener("click", () => playSentence(s.idx, 2));

    btns.appendChild(playBtn);
    btns.appendChild(repBtn);

    row.appendChild(textWrap);
    row.appendChild(btns);
    sentencesEl.appendChild(row);
  }
}

function highlight(idx){
  document.querySelectorAll(".sentence").forEach(el => el.classList.remove("active"));
  const row = document.querySelector(`.sentence[data-idx="${idx}"]`);
  if (row) row.classList.add("active");
}

function getSelectedVoice(){
  const uri = voiceSelect.value;
  return voices.find(v => v.voiceURI === uri) || null;
}

/* ============ VOICES ============ */
function loadVoices(){
  if (!("speechSynthesis" in window)){
    setStatus("Voice: not supported", true);
    return;
  }

  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = "";

  if (!voices.length){
    setStatus("Voice: empty (tap ‚ñ∂ once, then refresh)", true);
    return;
  }

  // Prefer English voices first
  const sorted = [...voices].sort((a,b) => {
    const aEn = (a.lang || "").toLowerCase().startsWith("en") ? 0 : 1;
    const bEn = (b.lang || "").toLowerCase().startsWith("en") ? 0 : 1;
    return aEn - bEn;
  });

  for (const v of sorted){
    const opt = document.createElement("option");
    opt.value = v.voiceURI;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    voiceSelect.appendChild(opt);
  }

  setStatus(`Voice: ${voices.length} loaded`, false);
}

if ("speechSynthesis" in window) {
  speechSynthesis.onvoiceschanged = () => loadVoices();
}

/* ============ SPEAK ============ */
function speakOnce(text){
  return new Promise((resolve, reject) => {
    const u = new SpeechSynthesisUtterance(text);
    const v = getSelectedVoice();
    if (v) u.voice = v;
    u.lang = v?.lang || "en-US";
    u.rate = Math.min(1.1, Math.max(0.6, Number(rateInput.value || 0.85)));
    u.onend = () => resolve();
    u.onerror = (e) => reject(e);
    speechSynthesis.speak(u);
  });
}

async function playSentence(idx, forceRepeat){
  playingAll = false;
  if ("speechSynthesis" in window) speechSynthesis.cancel();

  highlight(idx);

  const s = currentStory.sentences.find(x => x.idx === idx);
  if (!s) return;

  const repeat = Math.min(3, Math.max(1, Math.round(forceRepeat || Number(repeatInput.value || 1))));
  for (let i=0; i<repeat; i++){
    await speakOnce(s.text);
    // Small pause between repeats (not the main interval)
    if (i < repeat - 1) await sleep(250);
  }
}

async function playAll(){
  if (!currentStory) return;

  playingAll = true;
  if ("speechSynthesis" in window) speechSynthesis.cancel();

  const intervalMs = Math.max(0, Number(intervalInput.value || 0)) * 1000;

  for (const s of currentStory.sentences){
    if (!playingAll) break;

    highlight(s.idx);

    const repeat = Math.min(3, Math.max(1, Math.round(Number(repeatInput.value || 1))));
    for (let i=0; i<repeat; i++){
      if (!playingAll) break;
      await speakOnce(s.text);
      if (i < repeat - 1) await sleep(250);
    }

    if (!playingAll) break;
    if (intervalMs > 0) await sleep(intervalMs);
  }

  playingAll = false;
  highlight(-1);
}

function stopAll(){
  playingAll = false;
  if ("speechSynthesis" in window) speechSynthesis.cancel();
  highlight(-1);
}

/* ============ EVENTS ============ */
storySelect.addEventListener("change", (e) => {
  const id = e.target.value;
  currentStory = stories.find(s => s.id === id) || stories[0];
  stopAll();
  renderSentences();
});

refreshVoicesBtn.addEventListener("click", () => loadVoices());
playAllBtn.addEventListener("click", () => playAll());
stopBtn.addEventListener("click", () => stopAll());

/* ============ INIT ============ */
populateStories();
renderSentences();
loadVoices();
</script>
</body>
</html>
